generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  ENDED
}

model Experiment {
  experiment_id          String             @id
  status                 ExperimentStatus
  start_at               DateTime?
  end_at                 DateTime?
  targeting              Json?
  config_schema_version  Int                @default(1)
  created_at             DateTime           @default(now())
  updated_at             DateTime           @updatedAt
  variants               ExperimentVariant[]
  assignments            Assignment[]

  @@map("experiments")
}

model ExperimentVariant {
  id            String     @id @default(cuid())
  experiment_id String
  variant_id    String
  variant_name  String
  is_control    Boolean    @default(false)
  weight        Float
  config        Json
  created_at    DateTime   @default(now())
  experiment    Experiment @relation(fields: [experiment_id], references: [experiment_id], onDelete: Cascade)

  @@unique([experiment_id, variant_id], name: "experiment_variant_unique")
  @@index([experiment_id])
  @@map("experiment_variants")
}

model Assignment {
  id                 String     @id @default(cuid())
  anonymous_user_id  String
  experiment_id      String
  variant_id         String
  assigned_at        DateTime   @default(now())
  assignment_version Int        @default(1)
  context            Json?
  experiment         Experiment @relation(fields: [experiment_id], references: [experiment_id], onDelete: Cascade)

  @@unique([anonymous_user_id, experiment_id], name: "assignment_user_experiment_unique")
  @@index([anonymous_user_id])
  @@index([experiment_id])
  @@map("assignments")
}

model EventLog {
  id                 String   @id @default(cuid())
  event_id           String?  @unique
  anonymous_user_id  String
  session_id         String?
  install_id         String?
  platform           String?
  app_version        String?
  event_name         String
  occurred_at        DateTime
  received_at        DateTime @default(now())
  sent_at            DateTime?
  properties         Json?
  context            Json?
  assignment_version Int?
  assignments        Json?
  experiment_map     Json?
  schema_version     Int      @default(1)

  @@index([anonymous_user_id])
  @@index([session_id])
  @@index([event_name])
  @@index([occurred_at])
  @@map("event_logs")
}

model MetricRollup {
  id           String   @id @default(cuid())
  metric_name  String
  window_start DateTime
  window_end   DateTime
  dimensions   Json?
  value        Float
  computed_at  DateTime @default(now())

  @@index([metric_name])
  @@index([window_start])
  @@index([window_end])
  @@map("metric_rollups")
}
