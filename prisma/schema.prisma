generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  ENDED
}

enum RollupRunStatus {
  RUNNING
  SUCCESS
  FAILED
}

model Experiment {
  experiment_id          String             @id
  status                 ExperimentStatus
  start_at               DateTime?
  end_at                 DateTime?
  targeting              Json?
  config_schema_version  Int                @default(1)
  created_at             DateTime           @default(now())
  updated_at             DateTime           @updatedAt
  variants               ExperimentVariant[]
  assignments            Assignment[]

  @@map("experiments")
}

model ExperimentVariant {
  id            String     @id @default(cuid())
  experiment_id String
  variant_id    String
  variant_name  String
  is_control    Boolean    @default(false)
  weight        Float
  config        Json
  created_at    DateTime   @default(now())
  experiment    Experiment @relation(fields: [experiment_id], references: [experiment_id], onDelete: Cascade)

  @@unique([experiment_id, variant_id], name: "experiment_variant_unique")
  @@index([experiment_id])
  @@map("experiment_variants")
}

model Assignment {
  id                 String     @id @default(cuid())
  anonymous_user_id  String
  experiment_id      String
  variant_id         String
  assigned_at        DateTime   @default(now())
  assignment_version Int        @default(1)
  context            Json?
  experiment         Experiment @relation(fields: [experiment_id], references: [experiment_id], onDelete: Cascade)

  @@unique([anonymous_user_id, experiment_id], name: "assignment_user_experiment_unique")
  @@index([anonymous_user_id])
  @@index([experiment_id])
  @@map("assignments")
}

model EventLog {
  id                 String   @id @default(cuid())
  event_id           String?  @unique
  anonymous_user_id  String
  session_id         String?
  install_id         String?
  platform           String?
  app_version        String?
  event_name         String
  occurred_at        DateTime
  received_at        DateTime @default(now())
  sent_at            DateTime?
  properties         Json?
  context            Json?
  assignment_version Int?
  assignments        Json?
  experiment_map     Json?
  schema_version     Int      @default(1)

  @@index([anonymous_user_id])
  @@index([session_id])
  @@index([event_name])
  @@index([occurred_at])
  @@map("event_logs")
}

model MetricRollup {
  id           String   @id @default(cuid())
  metric_name  String
  window_start DateTime
  window_end   DateTime
  dimensions   Json?
  value        Float
  computed_at  DateTime @default(now())

  @@index([metric_name])
  @@index([window_start])
  @@index([window_end])
  @@map("metric_rollups")
}

model DailyMetricRollup {
  id            String   @id @default(cuid())
  day           DateTime
  metric_name   String
  dimension_key String   @default("overall")
  dimensions    Json?
  value         Float
  computed_at   DateTime @default(now())

  @@unique([day, metric_name, dimension_key], name: "daily_metric_rollup_unique")
  @@index([day])
  @@index([metric_name])
  @@map("daily_metric_rollups")
}

model ExperimentMetricRollup {
  id            String   @id @default(cuid())
  day           DateTime
  experiment_id String
  variant_id    String
  metric_name   String
  value         Float
  dimensions    Json?
  computed_at   DateTime @default(now())

  @@unique([day, experiment_id, variant_id, metric_name], name: "experiment_metric_rollup_unique")
  @@index([day])
  @@index([experiment_id])
  @@index([variant_id])
  @@map("experiment_metric_rollups")
}

model FunnelRollup {
  id            String   @id @default(cuid())
  day           DateTime
  funnel_name   String
  step_name     String
  dimension_key String   @default("overall")
  experiment_id String?
  variant_id    String?
  users_count   Int
  events_count  Int
  computed_at   DateTime @default(now())

  @@unique([day, funnel_name, step_name, dimension_key], name: "funnel_rollup_unique")
  @@index([day])
  @@index([experiment_id])
  @@index([variant_id])
  @@map("funnel_rollups")
}

model RollupRun {
  id           String          @id @default(cuid())
  job_name     String
  started_at   DateTime        @default(now())
  finished_at  DateTime?
  status       RollupRunStatus
  window_start DateTime
  window_end   DateTime
  rows_written Int             @default(0)
  ignored_count Int            @default(0)
  error_text   String?

  @@index([job_name])
  @@index([started_at])
  @@map("rollup_runs")
}
